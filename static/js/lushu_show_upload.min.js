var map;var bound;var infowindow;var polyline;var elevationService=new google.maps.ElevationService();var chart;var curPosMarker;var elevationResults;var distanceOfPoints=[0];var elevationGainOfPoints=[0];$(init);function init(){initMap();$("#exportGpx").click(function(){exportGpx(true)});$("#generateGpx").click(function(){exportGpx(false)});$("#toggleLushu").click(toggleLushu);$("#toggleDeleteLushu").click(toggleDeleteLushu);$("#changeMapSize").click(changeMapSize);chart=createChart();$("#toggleChart").click(function(){if(!this.i){this.i=0}var a=this.i%2==0;$("#chart").height(a?10:180);$("#toggleChart").text(a?"显示":"隐藏");this.i++;return false});getElevations(selectPoints(points,250))}function initMap(){var e=$(window).height()-200;$("#map_canvas").height(e);var l={zoom:14,center:points[0],mapTypeId:google.maps.MapTypeId.ROADMAP};if(min_lat*min_lng*max_lat*max_lng!=0){var h=new google.maps.LatLng(min_lat,min_lng);var a=new google.maps.LatLng(max_lat,max_lng);bound=new google.maps.LatLngBounds(h,a)}map=new google.maps.Map(document.getElementById("map_canvas"),l);if(!!bound){map.fitBounds(bound)}map.controls[google.maps.ControlPosition.TOP_RIGHT].push($("#changeMapSize").get(0));map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push($("#toggleChart").get(0));map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push($("#chart").get(0));var d='<div id="infoContent"></div>';infowindow=new google.maps.InfoWindow({content:d,maxWidth:400});google.maps.event.addListener(infowindow,"domready",function(){$("#infoContent").html(infowindow.content)});if(points.length>0){var f=new google.maps.Marker({position:points[0],map:map,icon:"/static/images/map/marker_greenA.png",title:"开始",draggable:false})}if(points.length>1){var k=new google.maps.Marker({position:points[points.length-1],map:map,icon:"/static/images/map/marker_redB.png",title:"停止",draggable:false})}var j={strokeColor:"#73B9FF",strokeOpacity:0.9,strokeWeight:4,path:points};polyline=new google.maps.Polyline(j);polyline.setMap(map);for(var c in waypoints){var g=waypoints[c];var b=new google.maps.Marker({position:g.latLng,map:map,title:"点击查看内容"});addEvent(b,g.content)}}function addEvent(a,b){google.maps.event.addListener(a,"click",function(){infowindow.content=b;infowindow.open(map,a)})}function changeMapSize(){var b=550;var c=$("#map_canvas").height();var a=c;if(c==b){a=$(window).height()-150;if(a<800){a=800}}else{a+=200}$("#map_canvas").height(a);google.maps.event.trigger(map,"resize");return false}function exportGpx(a){var c=[];for(var b=0;b<points.length;b++){c.push(points[b].lat()+","+points[b].lng())}$("input[name='points']").val(c.join(";"));$("input[name='download']").val(a);$("form").submit()}function selectPoints(c,e){if(c.length<=e){return c}var d=Math.ceil(c.length/e);var b=[];for(var a=0;a<c.length;a++){if(a%d==0){b.push(c[a])}}return b}function getElevations(d){for(var b in d){var e=d[b];var a=gw(e.lat(),e.lng());d[b]=new google.maps.LatLng(a[0],a[1])}var c={path:d,samples:512};elevationService.getElevationAlongPath(c,function(n,l){if(l==google.maps.ElevationStatus.OK){var m=[];elevationGainOfPoints=[0];var h=0;var u=8888;var k=8888;for(var o=0;o<n.length;o++){var t=n[o].elevation;m.push(t);if(t<k){k=t}if(o>0){var s=t-u;if(s>0){h+=s}elevationGainOfPoints.push(Math.round(h))}u=t}chart.yAxis[0].setExtremes(k,null);chart.series[0].setData(m,true);for(var o in n){var f=n[o];var p=wg(f.location.lat(),f.location.lng());f.location=new google.maps.LatLng(p[0],p[1])}elevationResults=n;var g=0;for(var o=1;o<elevationResults.length;o++){var j=elevationResults[o-1];var q=elevationResults[o];g+=getDistance(j.location.lat(),j.location.lng(),q.location.lat(),q.location.lng());distanceOfPoints.push(round(g/1000,1))}$("#totalElevationGain").text("累计上升："+Math.round(h)+"米")}else{alert("发生错误: "+l)}})}function createChart(){Highcharts.setOptions({lang:{exportButtonTitle:"导出",printButtonTitle:"打印",downloadPNG:"导出PNG",downloadJPEG:"导出JPEG",downloadPDF:"导出PDF",downloadSVG:"",resetZoom:"恢复",resetZoomTitle:"恢复"}});return new Highcharts.Chart({chart:{zoomType:"x",renderTo:"chart",backgroundColor:"rgba(255, 255, 255, 0.8)"},title:{text:"海拔"},subtitle:{text:""},xAxis:{labels:{formatter:function(){}}},yAxis:{labels:{style:{color:"#a0a095"},formatter:function(){return this.value+" m"}},title:{text:"海拔",style:{color:"#a0a095"}}},tooltip:{formatter:function(){var a=this.y;var c=distanceOfPoints[this.x];var b=elevationGainOfPoints[this.x];return"海拔："+Math.round(a)+" 米<br />距离：≈"+c+" 公里<br />累计上升："+b+"米"},shared:true,crosshairs:true},plotOptions:{series:{marker:{enabled:false},point:{events:{mouseOver:function(){var a=elevationResults[this.x].location;if(!curPosMarker){curPosMarker=new google.maps.Marker({position:a,map:map,icon:"/static/images/map/marker.png"})}else{curPosMarker.setPosition(a)}}}}},areaspline:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,"rgba(2,0,0,0)"]]},lineWidth:1,marker:{enabled:false,states:{hover:{enabled:true,radius:5}}},shadow:false,states:{hover:{lineWidth:1}}}},legend:{enabled:false},series:[{name:"海拔",color:"#a0a095",type:"areaspline",shadow:false}]})};