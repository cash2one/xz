var directionsDisplay;var directionsService=new google.maps.DirectionsService();var elevationService=new google.maps.ElevationService();var map;var center=new google.maps.LatLng(35.496456,112.097167);var zoomLevel=5;var noRoute=false;var note=$("#note");var allMarkers=[];var infowindow;var infowindowElevation=new google.maps.InfoWindow();var geocoder;var geoMarker;var startMarker,stopMarker;var chart;var curPosMarker;var elevationResults;var distanceOfPoints=[0];var elevationGainOfPoints=[0];$(init);function init(){if(lushuId==0){var a=new BMap.LocalCity();a.get(function(b){center=new google.maps.LatLng(b.center.lat,b.center.lng);zoomLevel=b.level-1;initialize()})}else{initialize()}$("#searchTxt").keypress(checkEnter);$("#searchBtn").click(search);$("input[name='points']").val("");$("input[name='waypoints']").val("");$("input[name='distance']").val(0);$("input[name='gpxPoints']").val("");$("#export").click(saveGps);$("#distanceTips, #circleLushuTips, #dragLushuTips").popover({"placement":"bottom",trigger:"hover"});$("#distanceTips, #circleLushuTips, #dragLushuTips").click(function(){return false});chart=createChart();$("#toggleChart").click(function(){if(!this.i){this.i=0}var b=this.i%2==0;$("#chart").height(b?10:180);$("#toggleChart").text(b?"显示":"隐藏");this.i++;return false})}function initialize(){var f=$(window).height()-100;$("#map_canvas").height(f);var b={zoom:zoomLevel,mapTypeId:google.maps.MapTypeId.ROADMAP,center:center};map=new google.maps.Map(document.getElementById("map_canvas"),b);geocoder=new google.maps.Geocoder();map.controls[google.maps.ControlPosition.TOP_CENTER].push($("#searchContainer").get(0));map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push($("#toggleChart").get(0));map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push($("#chart").get(0));if(lushuId!=0&&!!bound){map.fitBounds(bound)}var j={draggable:true,map:map};directionsDisplay=new google.maps.DirectionsRenderer(j);directionsDisplay.setMap(map);google.maps.event.addListener(directionsDisplay,"directions_changed",function(){var l=directionsDisplay.getDirections();if(l!=null){var k=l.routes[0].legs[0];startMarker.setPosition(k.start_location);stopMarker.setPosition(k.end_location)}var i=computeTotalDistance();$("#totalDistance").text(Math.round(i));getElevations(l.routes[0].overview_path)});if(lushuId!=0){var h=splitPoints(points);if(!!h){startMarker=new google.maps.Marker({position:points[0],map:map,icon:"/static/images/map/marker_greenA.png",title:"开始",draggable:true});stopMarker=new google.maps.Marker({position:points[points.length-1],map:map,icon:"/static/images/map/marker_redB.png",title:"停止",draggable:true});drawRoute(h.origin,h.dest,h.waypoints)}}var c='<div><h4>内容</h4><div><textarea id="waypointContent" style="width:300px;height:150px;" placeholder="可输入100字"></textarea></div><div><a id="waypointSave" class="btn">保存</a><a id="waypointDelete" class="pull-right" href="#">刪除此备注</a></div></div>';infowindow=new google.maps.InfoWindow({content:c,maxWidth:400});google.maps.event.addListener(infowindow,"closeclick",function(){});google.maps.event.addListener(infowindow,"domready",function(){$("#waypointContent").val(infowindow.marker.content);$("#waypointSave").click(function(){infowindow.marker.content=$("#waypointContent").val();infowindow.close();return false});$("#waypointDelete").click(function(){infowindow.marker.setMap(null);return false})});for(var d in waypoints){var g=waypoints[d];var e=new google.maps.Marker({position:g.latLng,map:map,title:"点击设置内容\r\n备注可以拖动",draggable:true});addEvent(e,g.content);allMarkers.push(e)}var a=new contextMenu({map:map});a.addItem("设置此处为起点",function(k,i){if(startMarker==null){startMarker=new google.maps.Marker({position:i,map:k,icon:"/static/images/map/marker_greenA.png",title:"开始",draggable:true});drawRouteByMarker()}else{startMarker.setPosition(i);drawRouteByMarker()}});a.addItem("设置此处为终点",function(k,i){if(stopMarker==null){stopMarker=new google.maps.Marker({position:i,map:k,icon:"/static/images/map/marker_redB.png",title:"停止",draggable:true});note.text("");drawRouteByMarker()}else{stopMarker.setPosition(i);drawRouteByMarker()}});a.addSep();a.addItem("添加备注",function(l,k){var i=new google.maps.Marker({position:k,map:l,title:"点击设置内容\r\n备注可以拖动",draggable:true});google.maps.event.addListener(i,"click",function(){infowindow.open(l,i);infowindow.marker=i});infowindow.open(l,i);infowindow.marker=i;allMarkers.push(i)});a.addItem("查询海拔",function(k,i){getElevation(i)})}function checkEnter(a){if(a.which==13){a.preventDefault();$("#searchBtn").click()}}function search(b){var a=$("#searchTxt").val();if(!a){return}geocoder.geocode({"address":a},function(e,d){if(d==google.maps.GeocoderStatus.OK){var c=e[0].geometry.location;map.setCenter(c);if(geoMarker==null){geoMarker=new google.maps.Marker({map:map,position:c})}geoMarker.setPosition(c)}else{if(d==google.maps.GeocoderStatus.ZERO_RESULTS){alert("没有找到此地点在地图上的位置，请修改后重新搜索")}else{alert("出错啦，请重试: "+d)}}})}function addEvent(a,b){google.maps.event.addListener(a,"click",function(){infowindow.marker=a;if(!infowindow.marker.init){infowindow.marker.content=b;infowindow.marker.init=true}infowindow.open(map,a)})}function splitPoints(d){if(!d||d.length<2){return null}var a={};a.origin=d[0];a.dest=d[d.length-1];a.waypoints=[];for(var c=1;c<d.length-1;c++){var b={};b.location=d[c];b.stopover=true;a.waypoints.push(b)}return a}function computeTotalDistance(){var e=directionsDisplay.getDirections();if(!e){return 0}var c=e.routes[0];var a=c.legs;var b=0;for(var d=0;d<a.length;d++){b+=a[d].distance.value}return b/1000}function saveGps(){var p=directionsDisplay.getDirections();var f=getValidMarkers();if(!p){alert("尚未生成路线");return}if(!$("input[name='title']").val()){alert("请输入简要说明");return}var l=0;if(!!p){var q=p.routes[0];var t=q.legs;for(var g=0;g<t.length;g++){l+=t[g].distance.value}var c=t[0].start_location;var o=t[t.length-1].end_location;var s=[];s.push(c.lat()+","+c.lng());if(lushuId==0){for(var g=0;g<t.length;g++){for(var e=0;e<t[g].via_waypoints.length;e++){var n=t[g].via_waypoints[e];s.push(n.lat()+","+n.lng())}}s.push(o.lat()+","+o.lng())}else{for(var g=0;g<t.length;g++){for(var e=0;e<t[g].via_waypoints.length;e++){var n=t[g].via_waypoints[e];s.push(n.lat()+","+n.lng())}s.push(t[g].end_location.lat()+","+t[g].end_location.lng())}}$("input[name='points']").val(s.join(";"));var h=[];for(var g=0;g<t.length;g++){for(var e=0;e<t[g].steps.length;e++){var u=t[g].steps[e].path;for(var d=0;d<u.length;d++){h.push(u[d].lat()+","+u[d].lng())}}}$("input[name='gpxPoints']").val(h.join(";"))}$("input[name='distance']").val(l);if(f.length!=0){var r=[];for(var g in f){var b=f[g];var a=b.getPosition();r.push(a.lat()+"--+--"+a.lng()+"--+--"+(!!b.content?b.content:""))}$("input[name='waypoints']").val(r.join("==+=="))}$("#saveForm").submit()}function getValidMarkers(){var b=[];for(var c in allMarkers){var a=allMarkers[c];if(a.getMap()!=null){b.push(a)}}return b}function drawRoute(a,b,d){var c={origin:a,destination:b,travelMode:google.maps.TravelMode.WALKING,waypoints:d};directionsService.route(c,function(e,f){if(f==google.maps.DirectionsStatus.OK){directionsDisplay.setDirections(e);startMarker.setMap(null);stopMarker.setMap(null);note.html("路线已经生成，现在<span class='label label-important'>可以拖动起点，终点或者直接拖动路线</span>，即可按照自己的要求生成路线")}else{if(f==google.maps.DirectionsStatus.ZERO_RESULTS){noRoute=true;google.maps.event.addListener(startMarker,"dragend",drawRouteByMarker);google.maps.event.addListener(stopMarker,"dragend",drawRouteByMarker);note.text("没有找到路线，请调整起点和终点，重新生成路线")}}})}function drawRouteByMarker(){if(startMarker!=null&&stopMarker!=null){drawRoute(startMarker.getPosition(),stopMarker.getPosition(),[])}}function getElevation(d){var c=gw(d.lat(),d.lng());var e=new google.maps.LatLng(c[0],c[1]);var b=[];b.push(e);var a={"locations":b};elevationService.getElevationForLocations(a,function(g,f){if(f==google.maps.ElevationStatus.OK){if(g[0]){infowindowElevation.setContent("此处海拔："+Math.round(g[0].elevation)+"米");infowindowElevation.setPosition(d);infowindowElevation.open(map)}else{alert("没有找到此位置的海拔: "+f)}}else{alert("发生错误: "+f)}})}function getElevations(d){for(var b in d){var e=d[b];var a=gw(e.lat(),e.lng());d[b]=new google.maps.LatLng(a[0],a[1])}var c={"path":d,"samples":512};elevationService.getElevationAlongPath(c,function(n,l){if(l==google.maps.ElevationStatus.OK){var m=[];elevationGainOfPoints=[0];var h=0;var u=8888;var k=8888;for(var o=0;o<n.length;o++){var t=n[o].elevation;m.push(t);if(t<k){k=t}if(o>0){var s=t-u;if(s>0){h+=s}elevationGainOfPoints.push(Math.round(h))}u=t}chart.yAxis[0].setExtremes(k,null);chart.series[0].setData(m,true);for(var o in n){var f=n[o];var p=wg(f.location.lat(),f.location.lng());f.location=new google.maps.LatLng(p[0],p[1])}elevationResults=n;distanceOfPoints=[0];var g=0;for(var o=1;o<elevationResults.length;o++){var j=elevationResults[o-1];var q=elevationResults[o];g+=getDistance(j.location.lat(),j.location.lng(),q.location.lat(),q.location.lng());distanceOfPoints.push(round(g/1000,1))}$("#totalElevationGain").text(Math.round(h))}else{alert("发生错误: "+l)}})}function createChart(){Highcharts.setOptions({lang:{exportButtonTitle:"导出",printButtonTitle:"打印",downloadPNG:"导出PNG",downloadJPEG:"导出JPEG",downloadPDF:"导出PDF",downloadSVG:"",resetZoom:"恢复",resetZoomTitle:"恢复"}});return new Highcharts.Chart({chart:{zoomType:"x",renderTo:"chart",backgroundColor:"rgba(255, 255, 255, 0.8)"},title:{text:"海拔"},subtitle:{text:""},xAxis:{labels:{formatter:function(){}}},yAxis:{labels:{style:{color:"#a0a095"},formatter:function(){return this.value+" m"}},title:{text:"海拔",style:{color:"#a0a095"}}},tooltip:{formatter:function(){var a=this.y;var c=distanceOfPoints[this.x];var b=elevationGainOfPoints[this.x];return"海拔："+Math.round(a)+" 米<br />距离：≈"+c+" 公里<br />累计上升："+b+"米"},shared:true,crosshairs:true},plotOptions:{series:{marker:{enabled:false},point:{events:{mouseOver:function(){var a=elevationResults[this.x].location;if(!curPosMarker){curPosMarker=new google.maps.Marker({position:a,map:map,icon:"/static/images/map/marker.png"})}else{curPosMarker.setPosition(a)}}}}},areaspline:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,"rgba(2,0,0,0)"]]},lineWidth:1,marker:{enabled:false,states:{hover:{enabled:true,radius:5}}},shadow:false,states:{hover:{lineWidth:1}}}},legend:{enabled:false},series:[{name:"海拔",color:"#a0a095",type:"areaspline",shadow:false}]})};
