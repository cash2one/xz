var elevationService=new google.maps.ElevationService();var map;var center=new google.maps.LatLng(35.496456,112.097167);var zoomLevel=5;var note=$("#note");var allMarkers=[];var infowindow;var infowindowElevation=new google.maps.InfoWindow();var geocoder;var geoMarker;var startMarker;var polyline;var EARTH_RADIUS=6378137;function rad(a){return a*Math.PI/180}function getDistance(d,i,c,g){var f=rad(d);var e=rad(c);var j=f-e;var h=rad(i)-rad(g);var k=2*Math.asin(Math.sqrt(Math.pow(Math.sin(j/2),2)+Math.cos(f)*Math.cos(e)*Math.pow(Math.sin(h/2),2)));k=k*EARTH_RADIUS;k=Math.round(k*10000)/10000;return k}$(init);function init(){var a=new BMap.LocalCity();a.get(function(b){center=new google.maps.LatLng(b.center.lat,b.center.lng);zoomLevel=b.level-1;initialize()});$("#searchTxt").keypress(checkEnter);$("#searchBtn").click(search);$("#deleteLastPoint").click(deleteLastPoint);$("input[name='points']").val("");$("input[name='waypoints']").val("");$("input[name='distance']").val(0);$("#export").click(saveGps)}function initialize(){var c=$(window).height()-100;$("#map_canvas").height(c);var b={zoom:zoomLevel,mapTypeId:google.maps.MapTypeId.ROADMAP,center:center};map=new google.maps.Map(document.getElementById("map_canvas"),b);geocoder=new google.maps.Geocoder();map.controls[google.maps.ControlPosition.TOP_CENTER].push($("#searchContainer").get(0));google.maps.event.addListener(map,"click",mapClicked);var a={strokeColor:"#73B9FF",strokeOpacity:0.9,strokeWeight:4};polyline=new google.maps.Polyline(a);polyline.setMap(map);var e='<div><h4>内容</h4><div><textarea id="waypointContent" style="width:300px;height:150px;" placeholder="可输入100字"></textarea></div><div><a id="waypointSave" class="btn">保存</a><a id="waypointDelete" class="pull-right" href="#">刪除此备注</a></div></div>';infowindow=new google.maps.InfoWindow({content:e,maxWidth:400});google.maps.event.addListener(infowindow,"closeclick",function(){});google.maps.event.addListener(infowindow,"domready",function(){$("#waypointContent").val(infowindow.marker.content);$("#waypointSave").click(function(){infowindow.marker.content=$("#waypointContent").val();infowindow.close();return false});$("#waypointDelete").click(function(){infowindow.marker.setMap(null);return false})});var d=new contextMenu({map:map});d.addItem("添加备注",function(h,g){var f=new google.maps.Marker({position:g,map:h,title:"点击设置内容\r\n备注可以拖动",draggable:true});google.maps.event.addListener(f,"click",function(){infowindow.open(h,f);infowindow.marker=f});infowindow.open(h,f);infowindow.marker=f;allMarkers.push(f)});d.addSep();d.addItem("查询海拔",function(g,f){getElevation(f)})}function mapClicked(c){var b=c.latLng;if(startMarker==null){startMarker=new google.maps.Marker({position:b,map:map,icon:"/static/images/map/marker_greenA.png",title:"开始",draggable:true})}drawLine(b);var a=computeTotalDistance(polyline.getPath());$("#totalDistance").text(Math.round(a/1000));$("#pointCount").text(polyline.getPath().getLength())}function drawLine(b){var c=polyline.getPath();if(c.getLength()>=100){alert("当前最多支持添加100个点");return}c.push(b);var a=c.getLength();if(a==1){startMarker.setMap(map);startMarker.setPosition(b)}}function deleteLastPoint(){var c=polyline.getPath();var b=c.getLength();if(b>0){c.removeAt(b-1);if(b==1){startMarker.setMap(null)}}var a=computeTotalDistance(polyline.getPath());$("#totalDistance").text(Math.round(a/1000));$("#pointCount").text(polyline.getPath().getLength())}function checkEnter(a){if(a.which==13){a.preventDefault();$("#searchBtn").click()}}function search(b){var a=$("#searchTxt").val();if(!a){return}geocoder.geocode({address:a},function(e,d){if(d==google.maps.GeocoderStatus.OK){var c=e[0].geometry.location;map.setCenter(c);if(geoMarker==null){geoMarker=new google.maps.Marker({map:map,position:c})}geoMarker.setPosition(c)}else{if(d==google.maps.GeocoderStatus.ZERO_RESULTS){alert("没有找到此地点在地图上的位置，请修改后重新搜索")}else{alert("出错啦，请重试: "+d)}}})}function computeTotalDistance(b){var a=0;if(b.getLength()>1){b.forEach(function(e,d){if(d!=0){var c=b.getAt(d-1);a+=getDistance(e.lat(),e.lng(),c.lat(),c.lng())}})}return Math.round(a)}function saveGps(){var f=polyline.getPath();var g=getValidMarkers();if(f.getLength()<=1&&g.length==0){return}if(!$("textarea[name='title']").val()){alert("请输入简要说明");return}var e=[];if(f.getLength()>1){f.forEach(function(j,i){e.push(j.lat()+","+j.lng())});$("input[name='points']").val(e.join(";"))}var c=computeTotalDistance(f);$("input[name='distance']").val(c);if(g.length!=0){var b=[];for(var d in g){var a=g[d];var h=a.getPosition();b.push(h.lat()+"--+--"+h.lng()+"--+--"+(!!a.content?a.content:""))}$("input[name='waypoints']").val(b.join("==+=="))}$("#saveForm").submit()}function getValidMarkers(){var b=[];for(var c in allMarkers){var a=allMarkers[c];if(a.getMap()!=null){b.push(a)}}return b}function getElevation(d){var c=[];var b=gw(d.lat(),d.lng());var e=new google.maps.LatLng(b[0],b[1]);c.push(e);var a={locations:c};elevationService.getElevationForLocations(a,function(g,f){if(f==google.maps.ElevationStatus.OK){if(g[0]){infowindowElevation.setContent("此处海拔："+Math.round(g[0].elevation)+"米");infowindowElevation.setPosition(d);infowindowElevation.open(map)}else{alert("没有找到此位置的海拔: "+f)}}else{alert("发生错误: "+f)}})};