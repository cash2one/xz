!function(){function e(e){for(var t=document.cookie,n=t.split("; "),o=0;o<n.length;o++){var s=n[o].split("=");if(e===s[0])return s[1]}return""}function t(){f=$("#voteCaptchaInput").val(),setTimeout(function(){1!=$("#imgCaptcha").children("ul").length&&$("#getCodeBtn").attr("disabled",!1)},500)}var n="/api/v4/account/register",o="/api/v4/account/login",s="/api/v4/send_msg",a="/api/v4/account/set_password",r="/api/v4/account/bind_account",i="/user/find_password",c=window.location.search;if(c.indexOf("?account")&&$("#setPswAccounts").val(c.slice(9)),-1!==document.cookie.indexOf("dandan")){var u=function(e){for(var t,n=document.cookie,o=n.split("; "),s=o.length,a=0;s>a;a++){var r=o[a].split("=");if(e===r[0]){t=r[1];break}}var i=t.length;if(i%4!==0)for(var c=0;4-i%4>c;c++)t+="=";return t=base64decode(t),t=t.split(":"),"1"===t[1]?$("#goUserpageLink").hide():$("#goUserpageLink").show().attr("href","/im/"+t[0]),t[0]};u("dandan")}var p=e("rd"),l=$("#pubkey").val(),d="/api/v4/captcha_reg",v=$("#voteCaptchaImg"),g=function(){$.get(d,function(){v.attr("src",d)})};g(),v.on("click",function(){g()});var f="";$("#getCodeBtn").attr("disabled",!0),$("#voteCaptchaInput").keyup(function(){4==$("#voteCaptchaInput").val().length?t():$("#getCodeBtn").attr("disabled",!0)}),$("#getCodeBtn").on("click",function(e){if($(this).attr("disabled"))e.preventDefault();else{var t=$("#signupAccountPhone").val(),n=$("#getCodeInput"),o=$("#getCodeBtn"),a=o.data("type"),r={account:t,type:a,isvoice:0,code:f},i={account:t,type:a,isvoice:1,code:f};t.length&&($(this).attr("disabled","disabled"),$.ajax({url:s,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(r)}).done(function(){n.focus(),o.text("60秒");var e=(new Date).getTime(),t=setInterval(function(){var n=(new Date).getTime(),a=Math.ceil(60-(n-e)/1e3);a>0?o.text(a+"秒"):(clearInterval(t),o.removeAttr("disabled").text("短信获取"),$(".form-group-voice-getcode").show(),$("#signupVoiceGetCodeBtn").one("click",function(e){e.preventDefault(),$.ajax({url:s,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(i)}).done(function(){showServerMsg("获取成功，请注意接听电话语音。","serve-msg-success"),$(".form-group-voice-getcode").hide(),console.log("success")}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error"),o.removeAttr("disabled").text("短信获取"),alert("1")})}))},1e3)}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error"),o.removeAttr("disabled").text("短信获取")}))}}),$("#loginForm").validator().on("submit",function(e){if(e.isDefaultPrevented())console.log("没通过验证");else{e.preventDefault();var t=$("#loginAccount").val(),n=$("#loginPassword").val()+";"+p,s=new JSEncrypt;s.setPublicKey(l),n=s.encrypt(n);var a={account:t,password:n,source:"web"};$.ajax({url:o,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(a)}).done(function(e){showServerMsg("登录成功！","serve-msg-success"),setTimeout(function(){window.location.assign("/im/"+e.data.enuid)},2e3)}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error")})}}),$("#signupForm").validator().on("submit",function(e){if(e.isDefaultPrevented());else{event.preventDefault();var t=$("#signupPassword").val()+";"+p,o=new JSEncrypt;o.setPublicKey(l),t=o.encrypt(t);var s=$("#signupAccountPhone").val(),a=$("#getCodeInput").val(),r={ltype:0,phone:s,password:t,keycode:parseInt(a),source:"web"};$.ajax({url:n,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(r)}).done(function(e){showServerMsg("注册成功！","serve-msg-success"),setTimeout(function(){window.location.assign("/im/"+e.data.enuid)},2e3)}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error")})}}),$("#signupEmailForm").validator().on("submit",function(e){if(e.isDefaultPrevented());else{event.preventDefault();var t=$("#signupEmailPassword").val()+";"+p,o=new JSEncrypt;o.setPublicKey(l),t=o.encrypt(t);var s=$("#signupEmailAccount").val(),a={ltype:1,email:s,password:t,source:"web"};$.ajax({url:n,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(a)}).done(function(e){showServerMsg("注册成功！","serve-msg-success"),setTimeout(function(){window.location.assign("/im/"+e.data.enuid)},2e3)}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error")})}}),$("#setPasswordForm").validator().on("submit",function(e){var t=$("#setPswPasswordInput");if(e.isDefaultPrevented());else{e.preventDefault();var n=t.val()+";"+p,o=new JSEncrypt;o.setPublicKey(l),n=o.encrypt(n),data={password:n},$.ajax({url:a,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(data)}).done(function(){showServerMsg("密码设置成功！","serve-msg-success"),setTimeout(function(){window.location.assign("/im/"+u("dandan"))},2e3)}).fail(function(){console.log("error")})}}),$("#bindAccountForm").on("click","#toggleAccountTypeBtn",function(e){$(this).hasClass("bind-phone")?($(".form-group-getcode").hide(),$(".form-group-phone").hide(),$(".form-group-email").show(),$(this).text("使用手机号绑定").removeClass("bind-phone")):($(".form-group-getcode").show(),$(".form-group-phone").show(),$(".form-group-email").hide(),$(this).text("使用邮箱绑定").addClass("bind-phone"))}),$("#bindAccountForm").validator().on("submit",function(e){if(e.isDefaultPrevented());else{event.preventDefault();var t=$("#signupPassword").val()+";"+p,n=new JSEncrypt;n.setPublicKey(l),t=n.encrypt(t);var o,s=$("#signupAccountPhone").val(),a=$("#signupAccountEmail").val(),i=$("#getCodeInput").val();o=$("#toggleAccountTypeBtn").hasClass("bind-phone")?{account:s,keycode:parseInt(i),password:t,source:"web"}:{account:a,password:t,source:"web"},$.ajax({url:r,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(o)}).done(function(e){showServerMsg("绑定成功！","serve-msg-success"),setTimeout(function(){window.location.assign("/im/"+e.data.enuid)},2e3)}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error"),$("#getCodeBtn").removeAttr("disabled").text("短信获取")})}});var m=$("#FindPasswordForm");m.on("click","#fpEmailToggle",function(){"phone"===m.attr("data-ftype")?(m.attr("data-ftype","email"),$(".form-show-phone").hide(),$(".form-show-email").show(),$(this).removeClass("fpemail-show").text("手机找回"),$("button[type=submit]").text("发送邮件")):(m.attr("data-ftype","phone"),$(".form-show-phone").show(),$(".form-show-email").hide(),$(this).addClass("fpemail-show").text("邮箱找回"),$("button[type=submit]").text("设置新密码"))}),m.validator().on("submit",function(e){if(e.isDefaultPrevented());else{e.preventDefault();var t=$("#fpPassword").val()+";"+p,n=new JSEncrypt;n.setPublicKey(l),t=n.encrypt(t);var o,s=$("#signupAccountPhone").val(),a=$("#getCodeInput").val(),r=$("#fpInputEmail").val(),c="";"phone"===m.attr("data-ftype")?(o={account:s,password:t,keycode:parseInt(a)},c="设置成功！请使用新密码登录"):(o={account:r},c="邮件发送成功！"),$.ajax({url:i,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(o)}).done(function(e){showServerMsg(c,"serve-msg-success"),setTimeout(function(){window.location.assign("/user/login")},2e3)}).fail(function(e){showServerMsg(JSON.parse(e.responseText).error_message,"serve-msg-error"),$("#getCodeBtn").removeAttr("disabled").text("短信获取")})}})}();