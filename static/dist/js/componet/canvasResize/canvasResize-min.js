!function($){function t(t,n){this.file=t,this.options=a.extend({},r,n),this._defaults=r,this._name=e,this.init()}var e="canvasResize",a={newsize:function(t,e,a,r,n){var i=n?"h":"";if(a&&t>a||r&&e>r){var o=t/e;(o>=1||0===r)&&a&&!n?(t=a,e=a/o>>0):n&&a/r>=o?(t=a,e=a/o>>0,i="w"):(t=r*o>>0,e=r)}return{width:t,height:e,cropped:i}},dataURLtoBlob:function(t){for(var e=t.split(",")[0].split(":")[1].split(";")[0],a=atob(t.split(",")[1]),r=new ArrayBuffer(a.length),n=new Uint8Array(r),i=0;i<a.length;i++)n[i]=a.charCodeAt(i);var o=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;return o?(o=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder),o.append(r),o.getBlob(e)):o=new Blob([r],{type:e})},detectSubsampling:function(t){var e=t.width,a=t.height;if(e*a>1048576){var r=document.createElement("canvas");r.width=r.height=1;var n=r.getContext("2d");return n.drawImage(t,-e+1,0),0===n.getImageData(0,0,1,1).data[3]}return!1},rotate:function(t,e){var a={1:{90:6,180:3,270:8},2:{90:7,180:4,270:5},3:{90:8,180:1,270:6},4:{90:5,180:2,270:7},5:{90:2,180:7,270:4},6:{90:3,180:8,270:1},7:{90:4,180:5,270:2},8:{90:1,180:6,270:3}};return a[t][e]?a[t][e]:t},transformCoordinate:function(t,e,a,r){switch(r){case 5:case 6:case 7:case 8:t.width=a,t.height=e;break;default:t.width=e,t.height=a}var n=t.getContext("2d");switch(r){case 1:break;case 2:n.translate(e,0),n.scale(-1,1);break;case 3:n.translate(e,a),n.rotate(Math.PI);break;case 4:n.translate(0,a),n.scale(1,-1);break;case 5:n.rotate(.5*Math.PI),n.scale(1,-1);break;case 6:n.rotate(.5*Math.PI),n.translate(0,-a);break;case 7:n.rotate(.5*Math.PI),n.translate(e,-a),n.scale(-1,1);break;case 8:n.rotate(-.5*Math.PI),n.translate(-e,0)}},detectVerticalSquash:function(t,e,a){var r=document.createElement("canvas");r.width=1,r.height=a;var n=r.getContext("2d");n.drawImage(t,0,0);for(var i=n.getImageData(0,0,1,a).data,o=0,c=a,h=a;h>o;){var s=i[4*(h-1)+3];0===s?c=h:o=h,h=c+o>>1}var l=h/a;return 0===l?1:l},callback:function(t){return t},extend:function(){var t=arguments[0]||{},e=1,r=arguments.length,n=!1;t.constructor===Boolean&&(n=t,t=arguments[1]||{}),1===r&&(t=this,e=0);for(var i;r>e;e++)if(null!==(i=arguments[e]))for(var o in i)t!==i[o]&&(n&&"object"==typeof i[o]&&t[o]?a.extend(t[o],i[o]):void 0!==i[o]&&(t[o]=i[o]));return t}},r={width:300,height:0,crop:!1,quality:80,rotate:0,callback:a.callback};t.prototype={init:function(){var t=this,e=this.file,r=new FileReader;r.onloadend=function(r){var n=r.target.result,i=atob(n.split(",")[1]),o=new BinaryFile(i,0,i.length),c=EXIF.readFromBinaryFile(o),h=new Image;h.onload=function(r){var n=c.Orientation||1;n=a.rotate(n,t.options.rotate);var i=n>=5&&8>=n?a.newsize(h.height,h.width,t.options.width,t.options.height,t.options.crop):a.newsize(h.width,h.height,t.options.width,t.options.height,t.options.crop),o=h.width,s=h.height,l=i.width,d=i.height,w=document.createElement("canvas"),u=w.getContext("2d");u.save(),a.transformCoordinate(w,l,d,n),a.detectSubsampling(h)&&(o/=2,s/=2);var g=1024,p=document.createElement("canvas");p.width=p.height=g;for(var v=p.getContext("2d"),f=a.detectVerticalSquash(h,o,s),m=0;s>m;){for(var b=m+g>s?s-m:g,B=0;o>B;){var I=B+g>o?o-B:g;v.clearRect(0,0,g,g),v.drawImage(h,-B,-m);var y=Math.floor(B*l/o),k=Math.ceil(I*l/o),x=Math.floor(m*d/s/f),M=Math.ceil(b*d/s/f);u.drawImage(p,0,0,I,b,y,x,k,M),B+=g}m+=g}u.restore(),p=v=null;var C=document.createElement("canvas");C.width="h"===i.cropped?d:l,C.height="w"===i.cropped?l:d;var R="h"===i.cropped?.5*(d-l):0,z="w"===i.cropped?.5*(l-d):0;if(newctx=C.getContext("2d"),newctx.drawImage(w,R,z,l,d),console.log(e,e.type),"image/png"===e.type)var E=C.toDataURL(e.type);else var E=C.toDataURL("image/jpeg",.01*t.options.quality);t.options.callback(E,C.width,C.height)},h.src=n},r.readAsDataURL(e)}},$[e]=function(e,r){return"string"==typeof e?a[e](r):void new t(e,r)}}(window);