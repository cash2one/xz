function init(){if(0===lushuId){var t=new BMap.LocalCity;t.get(function(t){center=new google.maps.LatLng(t.center.lat,t.center.lng),zoomLevel=t.level-1,initialize()})}else initialize();$("#searchTxt").keypress(checkEnter),$("#searchBtn").click(search),$("input[name='points']").val(""),$("input[name='waypoints']").val(""),$("input[name='distance']").val(0),$("input[name='gpxPoints']").val(""),$("#export").click(saveGps),$("#distanceTips, #circleLushuTips, #dragLushuTips").popover({placement:"bottom",trigger:"hover"}),$("#distanceTips, #circleLushuTips, #dragLushuTips").click(function(){return!1}),chart=createChart(),$("#toggleChart").click(function(){this.i||(this.i=0);var t=this.i%2===0;return $("#chart").height(t?10:180),$("#toggleChart").text(t?"显示":"隐藏"),this.i++,!1})}function initialize(){var t=$(window).height()-100;$("#map_canvas").height(t);var o={zoom:zoomLevel,mapTypeId:google.maps.MapTypeId.ROADMAP,center:center};map=new google.maps.Map(document.getElementById("map_canvas"),o),geocoder=new google.maps.Geocoder,map.controls[google.maps.ControlPosition.TOP_CENTER].push($("#searchContainer").get(0)),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push($("#toggleChart").get(0)),map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push($("#chart").get(0)),0!=lushuId&&bound&&map.fitBounds(bound);var e={draggable:!0,map:map};if(directionsDisplay=new google.maps.DirectionsRenderer(e),directionsDisplay.setMap(map),google.maps.event.addListener(directionsDisplay,"directions_changed",function(){var t=directionsDisplay.getDirections();if(null!=t){var o=t.routes[0].legs[0];startMarker.setPosition(o.start_location),stopMarker.setPosition(o.end_location)}var e=computeTotalDistance();$("#totalDistance").text(Math.round(e)),getElevations(t.routes[0].overview_path)}),0!=lushuId){var n=splitPoints(points);n&&(startMarker=new google.maps.Marker({position:points[0],map:map,icon:"/static/images/map/marker_greenA.png",title:"开始",draggable:!0}),stopMarker=new google.maps.Marker({position:points[points.length-1],map:map,icon:"/static/images/map/marker_redB.png",title:"停止",draggable:!0}),drawRoute(n.origin,n.dest,n.waypoints))}var a='<div><h4>内容</h4><div><textarea id="waypointContent" style="width:300px;height:150px;" placeholder="可输入100字"></textarea></div><div><a id="waypointSave" class="btn">保存并关闭</a><a id="waypointDelete" class="pull-right" href="#">刪除此备注</a></div></div>';infowindow=new google.maps.InfoWindow({content:a,maxWidth:400}),google.maps.event.addListener(infowindow,"closeclick",function(){return infowindow.marker.content="",$("#waypointContent").val(""),infowindow.close(),!1}),google.maps.event.addListener(infowindow,"domready",function(){$(".gm-style-iw").next("div").hide();for(var t=infowindow.marker.position.lat(),o=infowindow.marker.position.lng(),e=0;e<positions.length;e++)positions[e].lat===t&&positions[e].lng===o&&$("#waypointContent").val(positions[e].content);$("#waypointSave").click(function(){infowindow.marker.content=$("#waypointContent").val();var t=infowindow.marker.position.lat(),o=infowindow.marker.position.lng(),e=infowindow.marker.content;if(void 0===e)e="weikong";else for(var n=0;n<positions.length;n++)positions[n].lat===t&&positions[n].lng===o&&(positions[n].content=e);return $("#waypointContent").val(""),infowindow.close(),!1}),$("#waypointDelete").click(function(){infowindow.close(),infowindow.marker.setMap(null),Array.prototype.remove=function(t){if(isNaN(t)||t>this.length)return!1;for(var o=0,e=0;o<this.length;o++)this[o]!=this[t]&&(this[e++]=this[o]);this.length-=1};for(var t=infowindow.marker.position.lat(),o=infowindow.marker.position.lng(),e=0;e<positions.length;e++)if(positions[e].lat===t&&positions[e].lng===o)return positions.remove(e),positions;infowindow.marker.position.lat(),infowindow.marker.position.lng();return infowindow.marker.content="",$("#waypointContent").val(""),infowindow.close(),!1})});for(var i=0;i<waypoints.length;i++){var r=waypoints[i],s=new google.maps.Marker({position:r.latLng,map:map,title:"点击设置内容\r\n备注可以拖动",draggable:!0});addEvent(s,r.content),allMarkers.push(s)}var l=new contextMenu({map:map});l.addItem("设置此处为起点",function(t,o){null==startMarker?(startMarker=new google.maps.Marker({position:o,map:t,icon:"/static/images/map/marker_greenA.png",title:"开始",draggable:!0}),drawRouteByMarker()):(startMarker.setPosition(o),drawRouteByMarker())}),l.addItem("设置此处为终点",function(t,o){null==stopMarker?(stopMarker=new google.maps.Marker({position:o,map:t,icon:"/static/images/map/marker_redB.png",title:"停止",draggable:!0}),note.text(""),drawRouteByMarker()):(stopMarker.setPosition(o),drawRouteByMarker())}),l.addSep(),l.addItem("添加备注",function(t,o){var e,n,a=new google.maps.Marker({position:o,map:t,title:"点击设置内容\r\n备注可以拖动",draggable:!0});google.maps.event.addListener(a,"click",function(){var o=a.position.lat(),e=a.position.lng();infowindow.open(t,a),infowindow.marker=a;for(var n=0;n<positions.length;n++)positions[n].lat===o&&positions[n].lng===e&&$("#waypointContent").val(positions[n].content)}),infowindow.open(t,a),infowindow.marker=a,positions.push({lat:a.position.lat(),lng:a.position.lng()}),google.maps.event.addListener(a,"dragstart",function(t){e=t.latLng.lat(),n=t.latLng.lng()}),google.maps.event.addListener(a,"dragend",function(t){for(var o=0;o<positions.length;o++)positions[o].lat===e?(positions[o].lat=t.latLng.lat(),positions[o].lng=t.latLng.lng()):console.log("no")})}),l.addItem("查询海拔",function(t,o){getElevation(o)})}function checkEnter(t){13==t.which&&(t.preventDefault(),$("#searchBtn").click())}function search(t){var o=$("#searchTxt").val();o&&geocoder.geocode({address:o},function(t,o){if(o==google.maps.GeocoderStatus.OK){var e=t[0].geometry.location;map.setCenter(e),null==geoMarker&&(geoMarker=new google.maps.Marker({map:map,position:e})),geoMarker.setPosition(e)}else o==google.maps.GeocoderStatus.ZERO_RESULTS?alert("没有找到此地点在地图上的位置，请修改后重新搜索"):alert("出错啦，请重试: "+o)})}function addEvent(t,o){google.maps.event.addListener(t,"click",function(){console.log(o),infowindow.marker=t,infowindow.marker.content=o,$("#waypointContent").val(o),infowindow.marker.init||(infowindow.marker.content=o,infowindow.marker.init=!0),infowindow.open(map,t)})}function splitPoints(t){if(!t||t.length<2)return null;var o={};o.origin=t[0],o.dest=t[t.length-1],o.waypoints=[];for(var e=1;e<t.length-1;e++){var n={};n.location=t[e],n.stopover=!0,o.waypoints.push(n)}return o}function computeTotalDistance(){var t=directionsDisplay.getDirections();if(!t)return 0;for(var o=t.routes[0],e=o.legs,n=0,a=0;a<e.length;a++)n+=e[a].distance.value;return n/1e3}function saveGps(){var t=directionsDisplay.getDirections();if(!t)return void alert("尚未生成路线");if(!$("input[name='title']").val())return void alert("请输入简要说明");var o=0;if(t){for(var e=t.routes[0],n=e.legs,a=0;a<n.length;a++)o+=n[a].distance.value;var i=n[0].start_location,r=n[n.length-1].end_location,s=[];if(s.push(i.lat()+","+i.lng()),0==lushuId){for(var a=0;a<n.length;a++)for(var l=0;l<n[a].via_waypoints.length;l++){var p=n[a].via_waypoints[l];s.push(p.lat()+","+p.lng())}s.push(r.lat()+","+r.lng())}else for(var a=0;a<n.length;a++){for(var l=0;l<n[a].via_waypoints.length;l++){var p=n[a].via_waypoints[l];s.push(p.lat()+","+p.lng())}s.push(n[a].end_location.lat()+","+n[a].end_location.lng())}$("input[name='points']").val(s.join(";"));for(var g=[],a=0;a<n.length;a++)for(var l=0;l<n[a].steps.length;l++)for(var c=n[a].steps[l].path,d=0;d<c.length;d++)g.push(c[d].lat()+","+c[d].lng());$("input[name='gpxPoints']").val(g.join(";"))}if($("input[name='distance']").val(o),positions.length>0){for(var v=[],a=0;a<positions.length;a++){var u=positions[a];v.push(u.lat+"--+--"+u.lng+"--+--"+u.content)}$("input[name='waypoints']").val(v.join("==+=="))}$("#saveForm").submit()}function getValidMarkers(){var t=[];for(var o in allMarkers){var e=allMarkers[o];null!=e.getMap()&&t.push(e)}return t}function drawRoute(t,o,e){var n={origin:t,destination:o,travelMode:google.maps.TravelMode.WALKING,waypoints:e};directionsService.route(n,function(t,o){o==google.maps.DirectionsStatus.OK?(directionsDisplay.setDirections(t),startMarker.setMap(null),stopMarker.setMap(null),note.html("路线已经生成，现在<span class='label label-important'>可以拖动起点，终点或者直接拖动路线</span>，即可按照自己的要求生成路线")):o==google.maps.DirectionsStatus.ZERO_RESULTS&&(noRoute=!0,google.maps.event.addListener(startMarker,"dragend",drawRouteByMarker),google.maps.event.addListener(stopMarker,"dragend",drawRouteByMarker),note.text("没有找到路线，请调整起点和终点，重新生成路线"))})}function drawRouteByMarker(){null!=startMarker&&null!=stopMarker&&drawRoute(startMarker.getPosition(),stopMarker.getPosition(),[])}function getElevation(t){var o=gw(t.lat(),t.lng()),e=new google.maps.LatLng(o[0],o[1]),n=[];n.push(e);var a={locations:n};elevationService.getElevationForLocations(a,function(o,e){e==google.maps.ElevationStatus.OK?o[0]?(infowindowElevation.setContent("此处海拔："+Math.round(o[0].elevation)+"米"),infowindowElevation.setPosition(t),infowindowElevation.open(map)):alert("没有找到此位置的海拔: "+e):alert("发生错误: "+e)})}function getElevations(t){for(var o in t){var e=t[o],n=gw(e.lat(),e.lng());t[o]=new google.maps.LatLng(n[0],n[1])}var a={path:t,samples:512};elevationService.getElevationAlongPath(a,function(t,o){if(o==google.maps.ElevationStatus.OK){var e=[];elevationGainOfPoints=[0];for(var n=0,a=8888,i=8888,r=0;r<t.length;r++){var s=t[r].elevation;if(e.push(s),i>s&&(i=s),r>0){var l=s-a;l>0&&(n+=l),elevationGainOfPoints.push(Math.round(n))}a=s}chart.yAxis[0].setExtremes(i,null),chart.series[0].setData(e,!0);for(var r in t){var p=t[r],g=wg(p.location.lat(),p.location.lng());p.location=new google.maps.LatLng(g[0],g[1])}elevationResults=t,distanceOfPoints=[0];for(var c=0,r=1;r<elevationResults.length;r++){var d=elevationResults[r-1],v=elevationResults[r];c+=getDistance(d.location.lat(),d.location.lng(),v.location.lat(),v.location.lng()),distanceOfPoints.push(round(c/1e3,1))}$("#totalElevationGain").text(Math.round(n))}else alert("发生错误: "+o)})}function createChart(){return Highcharts.setOptions({lang:{exportButtonTitle:"导出",printButtonTitle:"打印",downloadPNG:"导出PNG",downloadJPEG:"导出JPEG",downloadPDF:"导出PDF",downloadSVG:"",resetZoom:"恢复",resetZoomTitle:"恢复"}}),new Highcharts.Chart({chart:{zoomType:"x",renderTo:"chart",backgroundColor:"rgba(255, 255, 255, 0.8)"},title:{text:"海拔"},subtitle:{text:""},xAxis:{labels:{formatter:function(){}}},yAxis:{labels:{style:{color:"#a0a095"},formatter:function(){return this.value+" m"}},title:{text:"海拔",style:{color:"#a0a095"}}},tooltip:{formatter:function(){var t=this.y,o=distanceOfPoints[this.x],e=elevationGainOfPoints[this.x];return"海拔："+Math.round(t)+" 米<br />距离：≈"+o+" 公里<br />累计上升："+e+"米"},shared:!0,crosshairs:!0},plotOptions:{series:{marker:{enabled:!1},point:{events:{mouseOver:function(){var t=elevationResults[this.x].location;curPosMarker?curPosMarker.setPosition(t):curPosMarker=new google.maps.Marker({position:t,map:map,icon:"/static/images/map/marker.png"})}}}},areaspline:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,"rgba(2,0,0,0)"]]},lineWidth:1,marker:{enabled:!1,states:{hover:{enabled:!0,radius:5}}},shadow:!1,states:{hover:{lineWidth:1}}}},legend:{enabled:!1},series:[{name:"海拔",color:"#a0a095",type:"areaspline",shadow:!1}]})}var directionsDisplay,directionsService=new google.maps.DirectionsService,elevationService=new google.maps.ElevationService,map,center=new google.maps.LatLng(35.496456,112.097167),zoomLevel=5,noRoute=!1,note=$("#note"),allMarkers=[],infowindow,infowindowElevation=new google.maps.InfoWindow,geocoder,geoMarker,startMarker,stopMarker,chart,curPosMarker,elevationResults,distanceOfPoints=[0],elevationGainOfPoints=[0],positions=[];if(waypoints.length>0)for(var i=0;i<waypoints.length;i++)positions.push({lat:waypoints[i].latLng.lat(),lng:waypoints[i].latLng.lng(),content:waypoints[i].content});else var positions=[];$(init);