$(".datepicker").datepicker({format:"yyyy-mm-dd",language:"zh-CN",autoclose:!0}),$(function(){function e(){var e=new XMLHttpRequest,t=new FormData(l),n="/new_add_medal/";e.addEventListener("load",function(t){console.log(e.response);var n=JSON.parse(t.target.response);1==n.res?(showServerMsg("添加成功！","serve-msg-success"),setTimeout(function(){window.location.href="/medal_list/"},2e3)):(console.log(n.error_msg),showServerMsg(n.error_message,"serve-msg-error"))}),e.addEventListener("error",function(e){alert("发生未知错误，请尝试重新提交")}),e.open("POST",n),e.send(t)}var t=(document.querySelector("#addMedalTypeInp"),$("#medalTypesWrap"),document.querySelector("#buttonSubmit"),$("#mtype")),n=$(".file-upyun"),a=n.length,r=function(e){var t=e;t=new Date(Date.parse(t.replace(/-/g,"/")));var n=t.getTime();return n};$("#inputStarttime").on("change",function(){var e=$(this).val();$(this).next("input").val(r(e+" 00:00:00"))}),$("#inputEndtime").on("change",function(){var e=$(this).val();$(this).next("input").val(r(e+" 23:59:59"))});var i=0;mtypeStr="",$("#addMedalTypeBtn").on("click",function(e){e.preventDefault(),i+=1,mtypeStr+=i+",",t.val(mtypeStr);var r='<div class="medal-types-cont bg-info col-md-12"><h4>创建第'+i+'个类型勋章</h4><input type="text" class="form-control" name="'+i+'_title" placeholder="第'+i+'个类型标题" required><textarea class="form-control" name="'+i+'_desc" rows="3" maxlength="400" placeholder="第'+i+'个类型描述" required></textarea><div class="form-group"><input type="file" class="file-upyun" accept="image/*"><input type="hidden" name="'+i+'_pic"></div></div>';$("#medalTypesWrap").append(r),n=$(".file-upyun"),a=n.length;for(var p=0;p<n.length;p++)n[p].addEventListener("change",function(){var e=this,t=this.files[0],n={bucket:o.bucket,"save-key":"/medal/{filemd5}{.suffix}",expiration:Math.floor((new Date).getTime()/1e3)+86400,"allow-file-type":"jpg,jpeg,png,gif","content-length-range":"10240,10240000"},a=window.btoa(JSON.stringify(n)),r=CryptoJS.MD5(a+"&"+o.form_api),i=new FormData;i.append("policy",a),i.append("signature",r),i.append("file",t);var p=new XMLHttpRequest;p.open("POST",o.api+n.bucket),p.onload=function(t){e.nextElementSibling.value="http://static.imxingzhe.com"+JSON.parse(p.response).url;var n=document.createElement("img");n.src="http://static.imxingzhe.com"+JSON.parse(p.response).url+"!avatar",n.width=80,e.parentNode.insertBefore(n,null)},p.send(i)})});for(var o={api:"http://v0.api.upyun.com/",bucket:"xingzhe-img",form_api:"loO4HjINwaV6UmjD14riVfV252w="},p=0;p<n.length;p++)n[p].addEventListener("change",function(){var e=this,t=this.files[0],n={bucket:o.bucket,"save-key":"/medal/{filemd5}{.suffix}",expiration:Math.floor((new Date).getTime()/1e3)+86400,"allow-file-type":"jpg,jpeg,png,gif","content-length-range":"10240,10240000"},a=window.btoa(JSON.stringify(n)),r=CryptoJS.MD5(a+"&"+o.form_api),i=new FormData;i.append("policy",a),i.append("signature",r),i.append("file",t);var p=new XMLHttpRequest;p.open("POST",o.api+n.bucket),p.onload=function(t){e.nextElementSibling.value="http://static.imxingzhe.com"+JSON.parse(p.response).url;var n=document.createElement("img");n.src="http://static.imxingzhe.com"+JSON.parse(p.response).url,n.width=80,e.parentNode.insertBefore(n,null)},p.send(i)});var l=document.getElementById("addMedalForm");l.addEventListener("submit",function(t){t.preventDefault(),e()})});