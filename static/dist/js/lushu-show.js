function init(){initMap(),$("#exportGpx").click(function(){exportGpx(!0)}),$("#generateGpx").click(function(){exportGpx(!1)}),$("#toggleLushu").click(toggleLushu),$("#toggleDeleteLushu").click(toggleDeleteLushu),$("#changeMapSize").click(changeMapSize),chart=createChart(),$("#toggleChart").click(function(){this.i||(this.i=0);var t=this.i%2===0;return $("#chart").height(t?10:180),$("#toggleChart").text(t?"显示":"隐藏"),this.i++,!1})}function initMap(){var t=$(window).height()-200;$("#map_canvas").height(t);var e={zoom:14,center:points[0],mapTypeId:google.maps.MapTypeId.ROADMAP};if(min_lat*min_lng*max_lat*max_lng!==0){var o=new google.maps.LatLng(min_lat,min_lng),n=new google.maps.LatLng(max_lat,max_lng);bound=new google.maps.LatLngBounds(o,n)}map=new google.maps.Map(document.getElementById("map_canvas"),e),bound&&map.fitBounds(bound);var a={draggable:!1,map:map};directionsDisplay=new google.maps.DirectionsRenderer(a),directionsDisplay.setMap(map),map.controls[google.maps.ControlPosition.TOP_RIGHT].push($("#changeMapSize").get(0)),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push($("#toggleChart").get(0)),map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push($("#chart").get(0));var i=splitPoints(points);i&&drawRoute(i.origin,i.dest,i.waypoints);var r='<div id="infoContent"></div>';infowindow=new google.maps.InfoWindow({content:r,maxWidth:400}),google.maps.event.addListener(infowindow,"domready",function(){$("#infoContent").html(infowindow.content)});for(var s in waypoints){var l=waypoints[s],g=new google.maps.Marker({position:l.latLng,map:map,title:"点击查看内容"});addEvent(g,l.content)}}function addEvent(t,e){google.maps.event.addListener(t,"click",function(){infowindow.open(map,t);for(var e=0;e<waypoints.length;e++)waypoints[e].latLng===infowindow.position&&(infowindow.content=waypoints[e].content)})}function splitPoints(t){if(!t||t.length<2)return null;var e={};e.origin=t[0],e.dest=t[t.length-1],e.waypoints=[];for(var o=1;o<t.length-1;o++){var n={};n.location=t[o],n.stopover=!0,e.waypoints.push(n)}return e}function drawRoute(t,e,o){var n={origin:t,destination:e,travelMode:google.maps.TravelMode.WALKING,waypoints:o};directionsService.route(n,function(t,e){e==google.maps.DirectionsStatus.OK?(directionsDisplay.setDirections(t),getElevations(t.routes[0].overview_path)):e==google.maps.DirectionsStatus.ZERO_RESULTS})}function changeMapSize(){var t=550,e=$("#map_canvas").height(),o=e;return e==t?(o=$(window).height()-150,800>o&&(o=800)):o+=200,$("#map_canvas").height(o),google.maps.event.trigger(map,"resize"),!1}function exportGpx(t){var e=directionsDisplay.getDirections();if(e){for(var o=e.routes[0],n=o.legs,a=(n[0].start_location,n[n.length-1].end_location,[]),i=0;i<n.length;i++)for(var r=0;r<n[i].steps.length;r++)for(var s=n[i].steps[r].path,l=0;l<s.length;l++)a.push(s[l].lat()+","+s[l].lng());$("input[name='points']").val(a.join(";")),$("input[name='download']").val(t),$("form").submit()}}function getElevations(t){for(var e in t){var o=t[e],n=gw(o.lat(),o.lng());t[e]=new google.maps.LatLng(n[0],n[1])}var a={path:t,samples:512};elevationService.getElevationAlongPath(a,function(t,e){if(e==google.maps.ElevationStatus.OK){var o=[];elevationGainOfPoints=[0];for(var n=0,a=8888,i=8888,r=0;r<t.length;r++){var s=t[r].elevation;if(o.push(s),i>s&&(i=s),r>0){var l=s-a;l>0&&(n+=l),elevationGainOfPoints.push(Math.round(n))}a=s}chart.yAxis[0].setExtremes(i,null),chart.series[0].setData(o,!0);for(var r in t){var g=t[r],p=wg(g.location.lat(),g.location.lng());g.location=new google.maps.LatLng(p[0],p[1])}elevationResults=t;for(var c=0,r=1;r<elevationResults.length;r++){var h=elevationResults[r-1],u=elevationResults[r];c+=getDistance(h.location.lat(),h.location.lng(),u.location.lat(),u.location.lng()),distanceOfPoints.push(round(c/1e3,1))}$("#totalElevationGain").text("累计上升："+Math.round(n)+"米")}else alert("发生错误: "+e)})}function createChart(){return Highcharts.setOptions({lang:{exportButtonTitle:"导出",printButtonTitle:"打印",downloadPNG:"导出PNG",downloadJPEG:"导出JPEG",downloadPDF:"导出PDF",downloadSVG:"",resetZoom:"恢复",resetZoomTitle:"恢复"}}),new Highcharts.Chart({chart:{zoomType:"x",renderTo:"chart",backgroundColor:"rgba(255, 255, 255, 0.8)"},title:{text:"海拔"},subtitle:{text:""},xAxis:{labels:{formatter:function(){}}},yAxis:{labels:{style:{color:"#a0a095"},formatter:function(){return this.value+" m"}},title:{text:"海拔",style:{color:"#a0a095"}}},tooltip:{formatter:function(){var t=this.y,e=distanceOfPoints[this.x],o=elevationGainOfPoints[this.x];return"海拔："+Math.round(t)+" 米<br />距离：≈"+e+" 公里<br />累计上升："+o+"米"},shared:!0,crosshairs:!0},plotOptions:{series:{marker:{enabled:!1},point:{events:{mouseOver:function(){var t=elevationResults[this.x].location;curPosMarker?curPosMarker.setPosition(t):curPosMarker=new google.maps.Marker({position:t,map:map,icon:"/static/images/map/marker.png"})}}}},areaspline:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,"rgba(2,0,0,0)"]]},lineWidth:1,marker:{enabled:!1,states:{hover:{enabled:!0,radius:5}}},shadow:!1,states:{hover:{lineWidth:1}}}},legend:{enabled:!1},series:[{name:"海拔",color:"#a0a095",type:"areaspline",shadow:!1}]})}var map,bound,directionsDisplay,directionsService=new google.maps.DirectionsService,elevationService=new google.maps.ElevationService,infowindow,chart,curPosMarker,elevationResults,distanceOfPoints=[0],elevationGainOfPoints=[0];$(init);